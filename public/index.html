<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>प्राइवेट कॉल</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      text-align: center;
      background: linear-gradient(135deg, #667eea, #764ba2);
      margin: 0; padding: 20px;
      color: white;
    }
    h1 { margin-bottom: 10px; }
    .status { font-size: 18px; margin-bottom: 20px; font-weight: bold; }
    .video-container { display: flex; justify-content: center; gap: 20px; margin-bottom: 20px; }
    video {
      width: 50%; max-width: 500px;
      border-radius: 5px;
      border: 1px solid rgba(255,255,255,0.3);
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
      background: black;
    }
    .controls { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
    button {
      padding: 12px 20px; font-size: 15px; border: none;
      border-radius: 25px; cursor: pointer; transition: 0.3s;
      font-weight: bold;
    }
    button:hover { transform: scale(1.05); }
    #video-call-btn { background: #00c853; color: white; }
    #audio-call-btn { background: #2196F3; color: white; }
    #end-btn { background: #f44336; color: white; display: none; }
    .extra { background: #333; color: white; display: none; }
  </style>
</head>
<body>
  <h1></h1>
  <div class="status" id="call-status">कोई कॉल शुरू नहीं है</div>

  <div class="video-container">
    <video id="local-video" autoplay muted playsinline></video>
    <video id="remote-video" autoplay playsinline></video>
  </div>

  <div class="controls">
    <button id="video-call-btn">
  <i class="fas fa-video"></i> वीडियो कॉल
</button>
<button id="audio-call-btn">
  <i class="fas fa-microphone"></i> ऑडियो कॉल
</button>
        <button id="end-btn">कॉल समाप्त करें</button>
    <!-- Extra Controls -->
    <button id="mute-btn">
        <i class="fas fa-microphone-slash"></i> म्यूट
    </button>
   <button id="camera-hide-btn">
    <i class="fas fa-video-slash"></i> कैमरा हाइड
</button>

    <button id="camera-btn">
    <i class="fas fa-video"></i> कैमरा
</button>
    <button id="speaker-btn">
        <i class="fas fa-volume-up"></i> स्पीकर
    </button>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const localVideo = document.getElementById('local-video');
    const remoteVideo = document.getElementById('remote-video');
    const videoCallBtn = document.getElementById('video-call-btn');
    const audioCallBtn = document.getElementById('audio-call-btn');
    const endBtn = document.getElementById('end-btn');
    const callStatus = document.getElementById('call-status');

    // extra buttons
    const muteBtn = document.getElementById('mute-btn');
    const videoToggleBtn = document.getElementById('video-toggle-btn');
    const cameraSwitchBtn = document.getElementById('camera-switch-btn');
    const speakerBtn = document.getElementById('speaker-btn');

    const socket = io();
    let peerConnection;
    let localStream;
    let isMuted = false;
    let videoEnabled = true;
    let usingFront = true;
    let speakerOn = false;

    const servers = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

    videoCallBtn.addEventListener('click', () => startCall({ video: true, audio: true }));
    audioCallBtn.addEventListener('click', () => startCall({ video: false, audio: true }));
    endBtn.addEventListener('click', endCall);

    // ✅ Mute toggle
    muteBtn.onclick = () => {
      if (localStream) {
        isMuted = !isMuted;
        localStream.getAudioTracks()[0].enabled = !isMuted;
        muteBtn.innerText = isMuted ? "अनम्यूट" : "म्यूट";
      }
    };

    // ✅ Video toggle
    videoToggleBtn.onclick = () => {
      if (localStream) {
        videoEnabled = !videoEnabled;
        localStream.getVideoTracks()[0].enabled = videoEnabled;
        videoToggleBtn.innerText = videoEnabled ? "बंद" : "चालू";
      }
    };

    // ✅ Camera switch
    cameraSwitchBtn.onclick = async () => {
      if (!localStream) return;
      usingFront = !usingFront;
      const newStream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: usingFront ? "user" : "environment" },
        audio: true
      });
      const newVideoTrack = newStream.getVideoTracks()[0];

      const sender = peerConnection.getSenders().find(s => s.track.kind === "video");
      sender.replaceTrack(newVideoTrack);

      localStream.getTracks().forEach(track => track.stop());
      localStream = newStream;
      localVideo.srcObject = localStream;
    };

    // ✅ Speaker toggle (mobile browsers में limited support)
    speakerBtn.onclick = () => {
      speakerOn = !speakerOn;
      remoteVideo.muted = !speakerOn;
      speakerBtn.innerText = speakerOn ? "स्पीकर" : "इयरपीस";
    };

    async function startCall(mediaConstraints) {
      videoCallBtn.style.display = 'none';
      audioCallBtn.style.display = 'none';
      endBtn.style.display = 'inline-block';
      muteBtn.style.display = videoToggleBtn.style.display = cameraSwitchBtn.style.display = speakerBtn.style.display = "inline-block";
      callStatus.innerText = "कॉल शुरू हो रही है...";

      try {
        localStream = await navigator.mediaDevices.getUserMedia(mediaConstraints);
        localVideo.srcObject = localStream;

        peerConnection = new RTCPeerConnection(servers);
        localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

        peerConnection.ontrack = (event) => {
          if (event.streams && event.streams[0]) {
            remoteVideo.srcObject = event.streams[0];
            callStatus.innerText = "कॉल कनेक्टेड";
          }
        };

        peerConnection.onicecandidate = (event) => {
          if (event.candidate) socket.emit('ice-candidate', event.candidate);
        };

        peerConnection.onconnectionstatechange = () => {
          if (["disconnected","closed","failed"].includes(peerConnection.connectionState)) {
            callStatus.innerText = "कॉल कट गई";
            endCall();
          }
        };

        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        socket.emit('offer', offer);

      } catch (error) {
        console.error('कॉल शुरू करने में त्रुटि:', error);
        alert('कॉल शुरू नहीं हो सकी। कृपया अनुमति दें।');
        endCall();
      }
    }

    async function endCall() {
      if (peerConnection) {
        peerConnection.close();
        peerConnection = null;
      }
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
      }
      localVideo.srcObject = null;
      remoteVideo.srcObject = null;

      videoCallBtn.style.display = 'inline-block';
      audioCallBtn.style.display = 'inline-block';
      endBtn.style.display = 'none';
      muteBtn.style.display = videoToggleBtn.style.display = cameraSwitchBtn.style.display = speakerBtn.style.display = "none";

      callStatus.innerText = "❌ कॉल समाप्त हुई";
      socket.emit('call-ended');
    }

    // ✅ Incoming offer
    socket.on('offer', async (offer) => {
      const isReady = confirm('एक कॉल आ रही है। क्या आप उत्तर देना चाहते हैं?');
      if (isReady) {
        videoCallBtn.style.display = 'none';
        audioCallBtn.style.display = 'none';
        endBtn.style.display = 'inline-block';
        muteBtn.style.display = videoToggleBtn.style.display = cameraSwitchBtn.style.display = speakerBtn.style.display = "inline-block";
        callStatus.innerText = "कॉल कनेक्ट हो रही है...";

        try {
          const mediaConstraints = offer.sdp.includes('m=video') ? { video: true, audio: true } : { video: false, audio: true };
          localStream = await navigator.mediaDevices.getUserMedia(mediaConstraints);
          localVideo.srcObject = localStream;
          
          peerConnection = new RTCPeerConnection(servers);
          localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

          peerConnection.ontrack = (event) => {
            if (event.streams && event.streams[0]) {
              remoteVideo.srcObject = event.streams[0];
              callStatus.innerText = "कॉल कनेक्टेड";
            }
          };

          peerConnection.onicecandidate = (event) => {
            if (event.candidate) socket.emit('ice-candidate', event.candidate);
          };

          peerConnection.onconnectionstatechange = () => {
            if (["disconnected","closed","failed"].includes(peerConnection.connectionState)) {
              callStatus.innerText = "कॉल कट गई";
              endCall();
            }
          };

          await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
          const answer = await peerConnection.createAnswer();
          await peerConnection.setLocalDescription(answer);
          socket.emit('answer', answer);
        } catch (error) {
          console.error('कॉल का उत्तर देने में त्रुटि:', error);
          endCall();
        }
      } else {
        callStatus.innerText = "कॉल अस्वीकार की गई";
      }
    });

    socket.on('answer', async (answer) => {
      if (peerConnection && !peerConnection.currentRemoteDescription) {
        await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
      }
    });

    socket.on('ice-candidate', async (candidate) => {
      if (peerConnection) {
        try {
          await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
        } catch (e) {
          console.error('ICE Candidate जोड़ने में त्रुटि', e);
        }
      }
    });

    socket.on('call-ended', () => {
      callStatus.innerText = "कॉल दूसरी ओर से समाप्त हुई";
      endCall();
    });
  </script>
</body>
</html>
