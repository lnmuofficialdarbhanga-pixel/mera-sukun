<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡§™‡•ç‡§∞‡§æ‡§á‡§µ‡•á‡§ü ‡§ï‡•â‡§≤</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            text-align: center;
            background: linear-gradient(135deg, #667eea, #764ba2);
            margin: 0; padding: 20px;
            color: white;
        }
        h1 { margin-bottom: 10px; }
        .status { font-size: 18px; margin-bottom: 20px; font-weight: bold; }
        .video-container { display: flex; justify-content: center; gap: 20px; margin-bottom: 20px; }
      .video-container {
    display: flex; 
    justify-content: center; /* ‡§µ‡•Ä‡§°‡§ø‡§Ø‡•ã ‡§ï‡•ã ‡§π‡•â‡§∞‡§ø‡§ú‡•â‡§®‡•ç‡§ü‡§≤‡•Ä ‡§¨‡•Ä‡§ö ‡§Æ‡•á‡§Ç ‡§≤‡§æ‡§è‡§ó‡§æ */
    align-items: center; /* ‡§Ö‡§ó‡§∞ ‡§µ‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤‡•Ä ‡§¨‡•Ä‡§ö ‡§Æ‡•á‡§Ç ‡§≤‡§æ‡§®‡§æ ‡§π‡•ã ‡§§‡•ã */
    gap: 20px; 
    margin-bottom: 20px;
}

video {
    width: 45%; 
    max-width: 500px;
    border-radius: 5px;
    border: 1px solid rgba(255,255,255,0.3);
    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    background: black;
}
        .controls { display: none; flex-wrap: wrap; justify-content: center; gap: 10px; }
        button {
            padding: 12px 20px; font-size: 15px; border: none;
            border-radius: 25px; cursor: pointer; transition: 0.3s;
            font-weight: bold;
        }
        button:hover { transform: scale(1.05); }
        #video-call-btn { background: #00c853; color: white; }
        #audio-call-btn { background: #2196F3; color: white; }
        #end-btn { background: #f44336; color: white; display: none; }
        .extra { background: #333; color: white; display: none; }
        #login-section { margin-top: 50px; }
        #login-btn { background: #ff9800; color: white; }
        #logout-btn { background: #e91e63; color: white; display: none; margin-top: 15px; }
        #user-info { margin-top: 15px; font-size: 16px; font-weight: bold; }

        /* üîí Lock Screen */
        #lock-screen {
            position: fixed;
            top:0; left:0; right:0; bottom:0;
            background: rgba(0,0,0,0.94);
            display: none; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 9999;
            color: white;
            padding: 20px;
        }
        #lock-screen input {
            padding: 10px;
            border-radius: 5px;
            border: none;
            font-size: 16px;
            text-align: center;
            margin-bottom: 10px;
            width: 220px;
        }
        #unlock-btn {
            background: #4caf50; color:white;
            padding: 8px 20px;
            border:none; border-radius:5px;
            cursor:pointer; font-weight:bold;
        }

        /* small responsive */
        @media (max-width:700px) {
            .video-container { flex-direction: column; }
            video { width: 90%; }
        }
    </style>
</head>
<body>
 
    <div id="login-section">
        <button id="login-btn"><i class="fab fa-google"></i> Google ‡§∏‡•á ‡§≤‡•â‡§ó‡§ø‡§®</button>
        <div id="user-info"></div>
        <button id="logout-btn">‡§≤‡•â‡§ó‡§Ü‡§â‡§ü</button>
    </div>

    <div class="status" id="call-status">‡§ï‡•ã‡§à ‡§ï‡•â‡§≤ ‡§∂‡•Å‡§∞‡•Ç ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à</div>

    <div class="video-container">
        <video id="local-video" autoplay muted playsinline></video>
        <video id="remote-video" autoplay playsinline></video>
    </div>

    <div class="controls">
        <button id="video-call-btn"><i class="fas fa-video"></i> ‡§µ‡•Ä‡§°‡§ø‡§Ø‡•ã ‡§ï‡•â‡§≤</button>
        <button id="audio-call-btn"><i class="fas fa-microphone"></i> ‡§ë‡§°‡§ø‡§Ø‡•ã ‡§ï‡•â‡§≤</button>
        <button id="end-btn">‡§ï‡•â‡§≤ ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç</button>
        <button id="mute-btn" class="extra">üîá ‡§Æ‡•ç‡§Ø‡•Ç‡§ü</button>
        <button id="video-toggle-btn" class="extra">üì∑ ‡§¨‡§Ç‡§¶</button>
        <button id="camera-switch-btn" class="extra">üîÑ ‡§ï‡•à‡§Æ‡§∞‡§æ</button>
        <button id="speaker-btn" class="extra">üîä ‡§∏‡•ç‡§™‡•Ä‡§ï‡§∞</button>
    </div>

    <div id="lock-screen">
        
        <input type="password" id="lock-password" placeholder="‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç">
        <button id="unlock-btn">Unlock</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCacx1JD4PoNCwLvyQBvzY2SisKMTAs7Yo",
            authDomain: "mera-sukun.firebaseapp.com",
            databaseURL: "https://mera-sukun-default-rtdb.firebaseio.com",
            projectId: "mera-sukun",
            storageBucket: "mera-sukun.firebasestorage.app",
            messagingSenderId: "900921074457",
            appId: "1:900921074457:web:41af1ae2c3b1f09631db88"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        const allowedUsers = {
            "kumarikiransah2001@gmail.com": true,
            "prakashkumarraushan1@gmail.com": true
        };
      
      
      
      auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
.then(() => {
    console.log("‚úÖ Firebase Auth persistence LOCAL ‡§∏‡•á‡§ü ‡§π‡•ã ‡§ó‡§Ø‡§æ");
})
.catch((error) => {
    console.error("Persistence error:", error);
});

      
      
      
      
      
      

        const loginBtn = document.getElementById("login-btn");
        const logoutBtn = document.getElementById("logout-btn");
        const userInfo = document.getElementById("user-info");
        const controls = document.querySelector(".controls");
        const localVideo = document.getElementById('local-video');
        const remoteVideo = document.getElementById('remote-video');
        const videoCallBtn = document.getElementById('video-call-btn');
        const audioCallBtn = document.getElementById('audio-call-btn');
        const endBtn = document.getElementById('end-btn');
        const callStatus = document.getElementById('call-status');
        const muteBtn = document.getElementById('mute-btn');
        const videoToggleBtn = document.getElementById('video-toggle-btn');
        const cameraSwitchBtn = document.getElementById('camera-switch-btn');
        const speakerBtn = document.getElementById('speaker-btn');
        const lockScreen = document.getElementById('lock-screen');
        const unlockBtn = document.getElementById('unlock-btn');
        const lockPassInput = document.getElementById('lock-password');
        const LOCK_PASSWORD = "8003";

        let currentUserEmail = null;
        let targetEmail = null;
        let peerConnection;
        let localStream;
        let isMuted = false;
        let videoEnabled = true;
        let usingFront = true;
        let speakerOn = false;
        let callTimer;
        let socket;
        let remoteSocketId = null;
        const servers = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
        let isUnlocked = false;

        function showLock() {
            lockScreen.style.display = 'flex';
        }

        function hideLock() {
            lockScreen.style.display = 'none';
            lockPassInput.value = '';
        }

        // ‡§™‡•á‡§ú ‡§≤‡•ã‡§° ‡§π‡•ã‡§®‡•á ‡§™‡§∞ ‡§≤‡•â‡§ï ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§¶‡§ø‡§ñ‡§æ‡§ì
        window.onload = showLock;

        unlockBtn.onclick = () => {
            const pass = lockPassInput.value;
            if (pass === LOCK_PASSWORD) {
                isUnlocked = true;
                hideLock();
            } else {
                alert('‚ùå ‡§ó‡§≤‡§§ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°!');
            }
        };

        loginBtn.onclick = () => {
            if (!isUnlocked) {
                alert("‚ùå ‡§™‡§π‡§≤‡•á ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§Ö‡§®‡§≤‡•â‡§ï ‡§ï‡§∞‡•á‡§Ç!");
                return;
            }
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(err => alert(err.message));
        };

        logoutBtn.onclick = () => {
            if (currentUserEmail) {
                try { socket.emit('unregister', currentUserEmail); } catch(e){ }
            }
            auth.signOut();
        };

      
      
      
      
      
      
auth.onAuthStateChanged(user => {
    if (user) {
        if (allowedUsers[user.email]) {
            currentUserEmail = user.email;
            userInfo.innerHTML = "‡§≤‡•â‡§ó‡§ø‡§®: " + user.email;
            loginBtn.style.display = "none";
            logoutBtn.style.display = "inline-block";
            controls.style.display = "flex";

            targetEmail = (user.email === "kumarikiransah2001@gmail.com") 
                ? "prakashkumarraushan1@gmail.com" 
                : "kumarikiransah2001@gmail.com";

            if (!socket) initSocket();
            socket.emit('register', currentUserEmail);

            // ‚úÖ ‡§Ö‡§ó‡§∞ ‡§™‡•á‡§ú refresh ‡§π‡•Å‡§Ü ‡§π‡•à ‡§§‡•ã ‡§¨‡§∏ lock ‡§¶‡§ø‡§ñ‡§æ‡§ì
            if (!isUnlocked) {
                showLock();
            }
        } else {
            alert("‚ùå ‡§Ø‡§π Gmail ‡§Ö‡§≤‡§æ‡§â‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à!");
            auth.signOut();
        }
    }
});

      
      
      
      
      
      
      
  //   auth.onAuthStateChanged(user => {
  //       // ‡§Ø‡§¶‡§ø ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§≤‡•â‡§ó ‡§á‡§® ‡§π‡•à
  //       if (user) {
  //           // ‡§ú‡§æ‡§Ç‡§ö ‡§ï‡§∞‡•á‡§Ç ‡§ï‡§ø ‡§ï‡•ç‡§Ø‡§æ ‡§µ‡§π ‡§è‡§ï ‡§Ö‡§®‡•Å‡§Æ‡§§ ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§π‡•à
  //           if (allowedUsers[user.email] && isUnlocked) {
  //               currentUserEmail = user.email;
  //               userInfo.innerHTML = "‡§≤‡•â‡§ó‡§ø‡§®: " + user.email;
  //               loginBtn.style.display = "none";
  //               logoutBtn.style.display = "inline-block";
  //               controls.style.display = "flex";

  //               if (user.email === "kumarikiransah2001@gmail.com") {
  //                   targetEmail = "prakashkumarraushan1@gmail.com";
  //               } else {
  //                   targetEmail = "kumarikiransah2001@gmail.com";
  //               }

  //               if (!socket) initSocket();
  //               socket.emit('register', currentUserEmail);
  //           } else {
  //               // ‡§Ø‡§¶‡§ø ‡§µ‡§π ‡§Ö‡§®‡•Å‡§Æ‡§§ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à ‡§Ø‡§æ ‡§Ö‡§®‡§≤‡•â‡§ï ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§Ü ‡§π‡•à ‡§§‡•ã ‡§≤‡•â‡§ó‡§Ü‡§â‡§ü ‡§ï‡§∞ ‡§¶‡•á‡§Ç
  //               alert("‚ùå ‡§Ø‡§π Gmail ‡§Ö‡§≤‡§æ‡§â‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à ‡§Ø‡§æ ‡§™‡•á‡§ú ‡§Ö‡§®‡§≤‡•â‡§ï ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à!");
  //               auth.signOut();
  //           }
  //       } else {
  //           // ‡§Ø‡§¶‡§ø ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§≤‡•â‡§ó‡§Ü‡§â‡§ü ‡§π‡•ã ‡§ó‡§Ø‡§æ ‡§π‡•à
  //           currentUserEmail = null;
  //           targetEmail = null;
  //           userInfo.innerHTML = "";
  //           loginBtn.style.display = "inline-block";
  //           logoutBtn.style.display = "none";
  //           controls.style.display = "none";
  //           
  //           // ‡§ï‡•á‡§µ‡§≤ ‡§§‡§≠‡•Ä ‡§≤‡•â‡§ï ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç ‡§ú‡§¨ ‡§ï‡•ã‡§à ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§≤‡•â‡§ó ‡§á‡§® ‡§® ‡§π‡•ã
  //           if (isUnlocked) {
  //                // ‡§Ö‡§ó‡§∞ ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§®‡•á ‡§Ö‡§®‡§≤‡•â‡§ï ‡§ï‡§ø‡§Ø‡§æ ‡§•‡§æ ‡§≤‡•á‡§ï‡§ø‡§® ‡§µ‡§π ‡§≤‡•â‡§ó‡§Ü‡§â‡§ü ‡§π‡•ã ‡§ó‡§Ø‡§æ, ‡§§‡•ã ‡§á‡§∏‡•á ‡§∞‡•Ä‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
  //                isUnlocked = false;
  //           }
  //           showLock();
  //       }
  //   });
  
      
      
      
      
      
      
      
      
      
      
      

        document.addEventListener("visibilitychange", () => {
            if (document.hidden) showLock();
        });

        window.addEventListener("offline", showLock);

        function initSocket() {
            socket = io();
            socket.on('connect', () => {
                console.log('Socket connected', socket.id);
                if (typeof firebase !== 'undefined' && firebase.auth && firebase.auth().currentUser) {
                    const u = firebase.auth().currentUser;
                    if (u && u.email) {
                        currentUserEmail = u.email;
                        socket.emit('register', currentUserEmail);
                    }
                }
            });
            socket.on('user-unavailable', (data) => {
                alert(data.message || 'User not available');
                endCall();
            });
            socket.on('offer', async ({ offer, from, fromEmail }) => {
                const u = (firebase.auth().currentUser && firebase.auth().currentUser.email) || null;
                if (!u || !(['kumarikiransah2001@gmail.com','prakashkumarraushan1@gmail.com'].includes(u))) {
                    console.log('Offer received but user not authorized. Ignoring.');
                    return;
                }
                remoteSocketId = from;
                const isReady = confirm('üìû ‡§è‡§ï ‡§ï‡•â‡§≤ ‡§Ü ‡§∞‡§π‡•Ä ‡§π‡•à‡•§ ‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§â‡§§‡•ç‡§§‡§∞ ‡§¶‡•á‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?');
                if (!isReady) {
                    callStatus.innerText = "‡§ï‡•â‡§≤ ‡§Ö‡§∏‡•ç‡§µ‡•Ä‡§ï‡§æ‡§∞ ‡§ï‡•Ä ‡§ó‡§à";
                    return;
                }
                clearTimeout(callTimer);
                videoCallBtn.style.display = 'none';
                audioCallBtn.style.display = 'none';
                endBtn.style.display = 'inline-block';
                muteBtn.style.display = videoToggleBtn.style.display = cameraSwitchBtn.style.display = speakerBtn.style.display = "inline-block";
                callStatus.innerText = "‡§ï‡•â‡§≤ ‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à...";
                try {
                    const mediaConstraints = offer.sdp && offer.sdp.includes('m=video') ? { video: true, audio: true } : { video: false, audio: true };
                    localStream = await navigator.mediaDevices.getUserMedia(mediaConstraints);
                    localVideo.srcObject = localStream;
                    peerConnection = new RTCPeerConnection(servers);
                    localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
                    peerConnection.ontrack = (event) => {
                        if (event.streams && event.streams[0]) {
                            remoteVideo.srcObject = event.streams[0];
                            callStatus.innerText = "üìû ‡§ï‡•â‡§≤ ‡§ï‡§®‡•á‡§ï‡•ç‡§ü‡•á‡§°";
                            clearTimeout(callTimer);
                        }
                    };
                    peerConnection.onicecandidate = (event) => {
                        if (event.candidate) {
                            if (remoteSocketId) {
                                socket.emit('ice-candidate', { candidate: event.candidate, targetId: remoteSocketId });
                            } else {
                                socket.emit('ice-candidate', { candidate: event.candidate, targetEmail: targetEmail });
                            }
                        }
                    };
                    peerConnection.onconnectionstatechange = () => {
                        if (["disconnected","closed","failed"].includes(peerConnection.connectionState)) {
                            callStatus.innerText = "‡§ï‡•â‡§≤ ‡§ï‡§ü ‡§ó‡§à";
                            endCall();
                        }
                    };
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    socket.emit('answer', { answer, targetId: remoteSocketId });
                } catch (error) {
                    console.error('‡§ï‡•â‡§≤ ‡§ï‡§æ ‡§â‡§§‡•ç‡§§‡§∞ ‡§¶‡•á‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:', error);
                    endCall();
                }
            });
            socket.on('answer', async ({ answer, from }) => {
                if (peerConnection && !peerConnection.currentRemoteDescription) {
                    try {
                        await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                        remoteSocketId = from;
                    } catch (e) {
                        console.error('Answer set error', e);
                    }
                }
            });
            socket.on('ice-candidate', async ({ candidate, from }) => {
                if (peerConnection) {
                    try {
                        await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                    } catch (e) {
                        console.error('ICE Candidate ‡§ú‡•ã‡§°‡§º‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', e);
                    }
                }
            });
            socket.on('call-ended', () => {
                callStatus.innerText = "‡§ï‡•â‡§≤ ‡§¶‡•Ç‡§∏‡§∞‡•Ä ‡§ì‡§∞ ‡§∏‡•á ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§π‡•Å‡§à";
                endCall();
            });
        }
        videoCallBtn.addEventListener('click', () => startCall({ video: true, audio: true }));
        audioCallBtn.addEventListener('click', () => startCall({ video: false, audio: true }));
        endBtn.addEventListener('click', () => {
            if (remoteSocketId) {
                socket.emit('call-ended', { targetId: remoteSocketId });
            } else if (targetEmail) {
                socket.emit('call-ended', { targetEmail });
            } else {
                socket.emit('call-ended', {});
            }
            endCall();
        });
        muteBtn.onclick = () => {
            if (localStream) {
                isMuted = !isMuted;
                localStream.getAudioTracks()[0].enabled = !isMuted;
                muteBtn.innerText = isMuted ? "üîà ‡§Ö‡§®‡§Æ‡•ç‡§Ø‡•Ç‡§ü" : "üîá ‡§Æ‡•ç‡§Ø‡•Ç‡§ü";
            }
        };
        videoToggleBtn.onclick = () => {
            if (localStream && localStream.getVideoTracks().length) {
                videoEnabled = !videoEnabled;
                localStream.getVideoTracks()[0].enabled = videoEnabled;
                videoToggleBtn.innerText = videoEnabled ? "üì∑ ‡§¨‡§Ç‡§¶" : "üì∑ ‡§ö‡§æ‡§≤‡•Ç";
            }
        };
        cameraSwitchBtn.onclick = async () => {
            if (!localStream) return;
            usingFront = !usingFront;
            const newStream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: usingFront ? "user" : "environment" },
                audio: true
            });
            const newVideoTrack = newStream.getVideoTracks()[0];
            const sender = peerConnection.getSenders().find(s => s.track && s.track.kind === "video");
            if (sender) sender.replaceTrack(newVideoTrack);
            localStream.getTracks().forEach(track => track.stop());
            localStream = newStream;
            localVideo.srcObject = localStream;
        };
        speakerBtn.onclick = () => {
            speakerOn = !speakerOn;
            remoteVideo.muted = !speakerOn;
            speakerBtn.innerText = speakerOn ? "üîä ‡§∏‡•ç‡§™‡•Ä‡§ï‡§∞" : "üîà ‡§á‡§Ø‡§∞‡§™‡•Ä‡§∏";
        };
        async function startCall(mediaConstraints) {
            const user = (firebase.auth().currentUser && firebase.auth().currentUser.email) || null;
            if (!user || !(['kumarikiransah2001@gmail.com','prakashkumarraushan1@gmail.com'].includes(user))) {
                alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡§π‡§≤‡•á ‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§∏‡§π‡•Ä ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§π‡•ã‡§Ç‡•§');
                return;
            }
            videoCallBtn.style.display = 'none';
            audioCallBtn.style.display = 'none';
            endBtn.style.display = 'inline-block';
            muteBtn.style.display = videoToggleBtn.style.display = cameraSwitchBtn.style.display = speakerBtn.style.display = "inline-block";
            callStatus.innerText = "‡§ï‡•â‡§≤ ‡§∂‡•Å‡§∞‡•Ç ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à...";
            clearTimeout(callTimer);
            callTimer = setTimeout(() => {
                if (!remoteVideo.srcObject) {
                    endCall();
                    showLock();
                }
            }, 30000);
            try {
                localStream = await navigator.mediaDevices.getUserMedia(mediaConstraints);
                localVideo.srcObject = localStream;
                peerConnection = new RTCPeerConnection(servers);
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
                peerConnection.ontrack = (event) => {
                    if (event.streams && event.streams[0]) {
                        remoteVideo.srcObject = event.streams[0];
                        callStatus.innerText = "üìû ‡§ï‡•â‡§≤ ‡§ï‡§®‡•á‡§ï‡•ç‡§ü‡•á‡§°";
                        clearTimeout(callTimer);
                    }
                };
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        if (remoteSocketId) {
                            socket.emit('ice-candidate', { candidate: event.candidate, targetId: remoteSocketId });
                        } else {
                            socket.emit('ice-candidate', { candidate: event.candidate, targetEmail: targetEmail });
                        }
                    }
                };
                peerConnection.onconnectionstatechange = () => {
                    if (["disconnected","closed","failed"].includes(peerConnection.connectionState)) {
                        callStatus.innerText = "‡§ï‡•â‡§≤ ‡§ï‡§ü ‡§ó‡§à";
                        endCall();
                    }
                };
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                socket.emit('offer', { offer, targetEmail });
            } catch (error) {
                console.error('‡§ï‡•â‡§≤ ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:', error);
                alert('‡§ï‡•â‡§≤ ‡§∂‡•Å‡§∞‡•Ç ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∏‡§ï‡•Ä‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§¶‡•á‡§Ç‡•§');
                endCall();
            }
        }
        async function endCall() {
            clearTimeout(callTimer);
            if (peerConnection) {
                try { peerConnection.close(); } catch(e){ }
                peerConnection = null;
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            localVideo.srcObject = null;
            remoteVideo.srcObject = null;
            videoCallBtn.style.display = 'inline-block';
            audioCallBtn.style.display = 'inline-block';
            endBtn.style.display = 'none';
            muteBtn.style.display = videoToggleBtn.style.display = cameraSwitchBtn.style.display = speakerBtn.style.display = "none";
            callStatus.innerText = "‡§ï‡•â‡§≤ ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§π‡•Å‡§à";
            if (remoteSocketId) {
                socket.emit('call-ended', { targetId: remoteSocketId });
            } else if (targetEmail) {
                socket.emit('call-ended', { targetEmail });
            } else {
                socket.emit('call-ended', {});
            }
            remoteSocketId = null;
        }
        window.addEventListener('beforeunload', () => {
            try {
                if (firebase && firebase.auth && firebase.auth().currentUser && firebase.auth().currentUser.email) {
                    socket.emit('unregister', firebase.auth().currentUser.email);
                }
            } catch(e){}
        });
    </script>
</body>
</html>
